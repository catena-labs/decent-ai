import {
  AndroidAudioEncoder,
  AndroidOutputFormat,
  IOSAudioQuality,
  IOSOutputFormat,
  type RecordingOptions
} from "expo-av/build/Audio"

import { env } from "@/env"
import { isAndroid } from "@/lib/utils/platform"

export const AUDIO_CHAT_API_URL = `${env.EXPO_PUBLIC_API_URL}/api/audio/chat`
export const VOICES_API_URL = `${AUDIO_CHAT_API_URL}/voices`
export const VOICE_SAMPLE_URL = `${env.EXPO_PUBLIC_API_URL}/voice-samples/`
export const SPEECH_TRANSCRIPTION_HEADER = "x-decent-transcribed-user-input"
export const AUDIO_DATA_PREFIX = "data:audio/m4a;base64,"

export const RECORDING_VOLUME_FLOOR = isAndroid ? -40 : -20
export const RECORDING_SILENCE_MAX_MILLIS = 2600
export const RECORDING_SILENCE_HANDSFREE_MAX_MILLIS = 1600
export const RECORDING_SILENCE_CHECK_INTERVAL = 800
export const RECORDING_MAX_DURATION = 30 * 1000

export const DEFAULT_VOICE = {
  name: "Avery (US Fem)",
  provider: "cartesia",
  voiceId: "4604f4ca-e294-42bb-8979-7de685059100",
  sampleFile: "openai-alloy.mp3",
  voiceEmbedding: [
    -0.0062335636, -0.100738406, 0.013960976, -0.015657796, -0.015662387,
    -0.036040533, 0.05045248, 0.08681855, -0.06754222, -0.0025632966,
    -0.08869562, -0.038096257, 0.021009369, -0.064802945, -0.036293533,
    -0.19358766, 0.06843351, 0.009498045, -0.074540965, -0.022217466,
    -0.04000174, 0.16014573, 0.013739145, 0.026764017, -0.07490848,
    -0.0022128671, -0.04342112, 0.09188061, 0.026275055, 0.042863756,
    -0.031646505, 0.055093374, 0.058389045, 0.153414, -0.06039657, -0.10626891,
    0.014475631, -0.08364812, -0.047392584, 0.0047714156, 0.07236845,
    -0.014826717, 0.017593779, 0.17925523, 0.037459053, 0.14041017,
    -0.009655275, -0.01225343, 0.013371439, 0.024904717, 0.046987273,
    -0.044850137, 0.019985296, -0.0189977, -0.02468928, 0.0007174198,
    -0.0035461348, 0.041350964, -0.033468023, 0.010586614, 0.15108247,
    -0.044479765, 0.007824427, 0.06967981, -0.10777605, 0.06324615, -0.07221784,
    -0.050631016, -0.066043854, 0.05532345, -0.043004483, 0.02204342,
    0.17253162, 0.040034603, 0.060263265, -0.12506194, -0.11871302, 0.03154246,
    0.00006445856, 0.06695233, -0.023893846, -0.09083714, 0.043979228,
    0.0763288, -0.10928594, 0.00757427, -0.07348528, -0.05441363, 0.003938937,
    0.049858972, -0.031015432, -0.053333897, -0.059623018, 0.00055034383,
    -0.035841953, -0.09127166, 0.027346373, -0.035813686, 0.0009817437,
    0.17097461, 0.042239312, 0.01678693, -0.047582254, -0.08290916, 0.055834163,
    -0.016057082, -0.046213664, -0.056264974, 0.07852407, -0.032163143,
    0.07580978, 0.12022202, 0.16010882, 0.029899193, -0.11247474, -0.01398975,
    -0.0085379165, -0.04938184, -0.09208982, 0.08758805, -0.028461179,
    0.026650026, 0.05749906, -0.07695627, -0.061447814, 0.07343166,
    -0.010782775, 0.02041867, 0.096045814, 0.056259375, 0.13248943, 0.14112395,
    -0.024013245, -0.11127376, -0.059689987, -0.034714933, 0.029292585,
    -0.055162158, 0.13443878, -0.07132883, 0.04629158, 0.036492288, 0.008036973,
    -0.07088606, -0.08761872, -0.031484988, 0.044165887, 0.06942262,
    0.0059004184, -0.056478377, 0.15287466, 0.05473241, 0.033137497,
    -0.096998855, 0.09406541, -0.044617083, -0.07808064, 0.1644178, -0.11732823,
    -0.2067941, -0.0036399963, 0.053049665, -0.036945846, -0.017194873,
    0.008219311, 0.09518431, -0.002002869, -0.026924731, -0.115483515,
    -0.08874662, 0.06264156, -0.16725846, -0.0068394146, -0.07768709,
    -0.019174054, 0.024035702, 0.09218968, -0.06426681, 0.03947204, 0.028840816,
    0.053309657, 0.0325716, -0.061114915, -0.060703684, 0.072579764,
    -0.037615072, 0.07665918, -0.038727492, 0.08572237, -0.091292515,
    0.022160217, -0.04613152
  ]
}

export enum AudioModeState {
  INACTIVE,
  LOADING,
  IDLE,
  RECORDING,
  STOPRECORDING,
  TRANSCRIBING,
  PROMPTING,
  PLAYING
}

export const AudioModeRecordingOptions: RecordingOptions = {
  isMeteringEnabled: true,
  android: {
    extension: ".m4a",
    outputFormat: AndroidOutputFormat.MPEG_4,
    audioEncoder: AndroidAudioEncoder.AAC,
    sampleRate: 44100,
    numberOfChannels: 2,
    bitRate: 128000
  },
  ios: {
    extension: ".m4a",
    audioQuality: IOSAudioQuality.MIN,
    outputFormat: IOSOutputFormat.MPEG4AAC,
    sampleRate: 44100,
    numberOfChannels: 2,
    bitRate: 64000,
    linearPCMBitDepth: 16,
    linearPCMIsBigEndian: false,
    linearPCMIsFloat: false
  },
  web: {
    mimeType: "audio/webm",
    bitsPerSecond: 128000
  }
}
